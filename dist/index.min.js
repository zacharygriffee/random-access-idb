function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}globalThis.process={platform:"browser",cwd:()=>""};var t={exports:{}};function n(e){return e.length}var r={byteLength:n,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r++)n+=String.fromCharCode(e[r]);return n},write:function(e,t,r=0,i=n(t)){const o=Math.min(i,e.byteLength-r);for(let n=0;n<o;n++)e[r+n]=t.charCodeAt(n);return o}};const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=new Uint8Array(256);for(let e=0;e<64;e++)o[i.charCodeAt(e)]=e;function a(e){let t=e.length;return 61===e.charCodeAt(t-1)&&t--,t>1&&61===e.charCodeAt(t-1)&&t--,3*t>>>2}o[45]=62,o[95]=63;var s={byteLength:a,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r+=3)n+=i[e[r]>>2]+i[(3&e[r])<<4|e[r+1]>>4]+i[(15&e[r+1])<<2|e[r+2]>>6]+i[63&e[r+2]];return t%3==2?n=n.substring(0,n.length-1)+"=":t%3==1&&(n=n.substring(0,n.length-2)+"=="),n},write:function(e,t,n=0,r=a(t)){const i=Math.min(r,e.byteLength-n);for(let n=0,r=0;r<i;n+=4){const i=o[t.charCodeAt(n)],a=o[t.charCodeAt(n+1)],s=o[t.charCodeAt(n+2)],c=o[t.charCodeAt(n+3)];e[r++]=i<<2|a>>4,e[r++]=(15&a)<<4|s>>2,e[r++]=(3&s)<<6|63&c}return i}};function c(e){return e.length>>>1}var u={byteLength:c,toString:function(e){const t=e.byteLength;e=new DataView(e.buffer,e.byteOffset,t);let n="",r=0;for(let i=t-t%4;r<i;r+=4)n+=e.getUint32(r).toString(16).padStart(8,"0");for(;r<t;r++)n+=e.getUint8(r).toString(16).padStart(2,"0");return n},write:function(e,t,n=0,r=c(t)){const i=Math.min(r,e.byteLength-n);for(let r=0;r<i;r++){const i=l(t.charCodeAt(2*r)),o=l(t.charCodeAt(2*r+1));if(void 0===i||void 0===o)return e.subarray(0,r);e[n+r]=i<<4|o}return i}};function l(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-65+10:e>=97&&e<=102?e-97+10:void 0}function f(e){let t=0;for(let n=0,r=e.length;n<r;n++){const i=e.charCodeAt(n);if(i>=55296&&i<=56319&&n+1<r){const r=e.charCodeAt(n+1);if(r>=56320&&r<=57343){t+=4,n++;continue}}t+=i<=127?1:i<=2047?2:3}return t}let h,d;if("undefined"!=typeof TextDecoder){const e=new TextDecoder;h=function(t){return e.decode(t)}}else h=function(e){const t=e.byteLength;let n="",r=0;for(;r<t;){let i=e[r];if(i<=127){n+=String.fromCharCode(i),r++;continue}let o=0,a=0;if(i<=223?(o=1,a=31&i):i<=239?(o=2,a=15&i):i<=244&&(o=3,a=7&i),t-r-o>0){let t=0;for(;t<o;)i=e[r+t+1],a=a<<6|63&i,t+=1}else a=65533,o=t-r;n+=String.fromCodePoint(a),r+=o+1}return n};if("undefined"!=typeof TextEncoder){const e=new TextEncoder;d=function(t,n,r=0,i=f(n)){const o=Math.min(i,t.byteLength-r);return e.encodeInto(n,t.subarray(r,r+o)),o}}else d=function(e,t,n=0,r=f(t)){const i=Math.min(r,e.byteLength-n);e=e.subarray(n,n+i);let o=0,a=0;for(;o<t.length;){const n=t.codePointAt(o);if(n<=127){e[a++]=n,o++;continue}let r=0,i=0;for(n<=2047?(r=6,i=192):n<=65535?(r=12,i=224):n<=2097151&&(r=18,i=240),e[a++]=i|n>>r,r-=6;r>=0;)e[a++]=128|n>>r&63,r-=6;o+=n>=65536?2:1}return i};var g={byteLength:f,toString:h,write:d};function b(e){return 2*e.length}var y={byteLength:b,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t-1;r+=2)n+=String.fromCharCode(e[r]+256*e[r+1]);return n},write:function(e,t,n=0,r=b(t)){const i=Math.min(r,e.byteLength-n);let o=i;for(let r=0;r<t.length&&!((o-=2)<0);++r){const i=t.charCodeAt(r),o=i>>8,a=i%256;e[n+2*r]=a,e[n+2*r+1]=o}return i}};!function(e,t){const n=r,i=s,o=u,a=g,c=y,l=255===new Uint8Array(Uint16Array.of(255).buffer)[0];function f(e){switch(e){case"ascii":return n;case"base64":return i;case"hex":return o;case"utf8":case"utf-8":case void 0:return a;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return c;default:throw new Error(`Unknown encoding: ${e}`)}}function h(e){return e instanceof Uint8Array}function d(e,t,n){return"string"==typeof e?function(e,t){const n=f(t),r=new Uint8Array(n.byteLength(e));return n.write(r,e,0,r.byteLength),r}(e,t):Array.isArray(e)?function(e){const t=new Uint8Array(e.length);return t.set(e),t}(e):ArrayBuffer.isView(e)?function(e){const t=new Uint8Array(e.byteLength);return t.set(e),t}(e):function(e,t,n){return new Uint8Array(e,t,n)}(e,t,n)}function b(e,t,n,r,i){if(0===e.byteLength)return-1;if("string"==typeof n?(r=n,n=0):void 0===n?n=i?0:e.length-1:n<0&&(n+=e.byteLength),n>=e.byteLength){if(i)return-1;n=e.byteLength-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t)t=d(t,r);else if("number"==typeof t)return t&=255,i?e.indexOf(t,n):e.lastIndexOf(t,n);if(0===t.byteLength)return-1;if(i){let r=-1;for(let i=n;i<e.byteLength;i++)if(e[i]===t[-1===r?0:i-r]){if(-1===r&&(r=i),i-r+1===t.byteLength)return r}else-1!==r&&(i-=i-r),r=-1}else{n+t.byteLength>e.byteLength&&(n=e.byteLength-t.byteLength);for(let r=n;r>=0;r--){let n=!0;for(let i=0;i<t.byteLength;i++)if(e[r+i]!==t[i]){n=!1;break}if(n)return r}}return-1}function w(e,t,n,r){return b(e,t,n,r,!0)}function m(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}e.exports=t={isBuffer:h,isEncoding:function(e){try{return f(e),!0}catch{return!1}},alloc:function(e,n,r){const i=new Uint8Array(e);return void 0!==n&&t.fill(i,n,0,i.byteLength,r),i},allocUnsafe:function(e){return new Uint8Array(e)},allocUnsafeSlow:function(e){return new Uint8Array(e)},byteLength:function(e,t){return f(t).byteLength(e)},compare:function(e,t){if(e===t)return 0;const n=Math.min(e.byteLength,t.byteLength);e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let i=n-n%4;r<i;r+=4){if(e.getUint32(r,l)!==t.getUint32(r,l))break}for(;r<n;r++){const n=e.getUint8(r),i=t.getUint8(r);if(n<i)return-1;if(n>i)return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0},concat:function(e,t){void 0===t&&(t=e.reduce(((e,t)=>e+t.byteLength),0));const n=new Uint8Array(t);let r=0;for(const t of e){if(r+t.byteLength>n.byteLength){const e=t.subarray(0,n.byteLength-r);return n.set(e,r),n}n.set(t,r),r+=t.byteLength}return n},copy:function(e,t,n=0,r=0,i=e.byteLength){if(i>0&&i<r)return 0;if(i===r)return 0;if(0===e.byteLength||0===t.byteLength)return 0;if(n<0)throw new RangeError("targetStart is out of range");if(r<0||r>=e.byteLength)throw new RangeError("sourceStart is out of range");if(i<0)throw new RangeError("sourceEnd is out of range");n>=t.byteLength&&(n=t.byteLength),i>e.byteLength&&(i=e.byteLength),t.byteLength-n<i-r&&(i=t.length-n+r);const o=i-r;return e===t?t.copyWithin(n,r,i):t.set(e.subarray(r,i),n),o},equals:function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const n=e.byteLength;e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let i=n-n%4;r<i;r+=4)if(e.getUint32(r,l)!==t.getUint32(r,l))return!1;for(;r<n;r++)if(e.getUint8(r)!==t.getUint8(r))return!1;return!0},fill:function(e,t,n,r,i){if("string"==typeof t?"string"==typeof n?(i=n,n=0,r=e.byteLength):"string"==typeof r&&(i=r,r=e.byteLength):"number"==typeof t?t&=255:"boolean"==typeof t&&(t=+t),n<0||e.byteLength<n||e.byteLength<r)throw new RangeError("Out of range index");if(void 0===n&&(n=0),void 0===r&&(r=e.byteLength),r<=n)return e;if(t||(t=0),"number"==typeof t)for(let i=n;i<r;++i)e[i]=t;else{const o=(t=h(t)?t:d(t,i)).byteLength;for(let i=0;i<r-n;++i)e[i+n]=t[i%o]}return e},from:d,includes:function(e,t,n,r){return-1!==w(e,t,n,r)},indexOf:w,lastIndexOf:function(e,t,n,r){return b(e,t,n,r,!1)},swap16:function(e){const t=e.byteLength;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<t;n+=2)m(e,n,n+1);return e},swap32:function(e){const t=e.byteLength;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<t;n+=4)m(e,n,n+3),m(e,n+1,n+2);return e},swap64:function(e){const t=e.byteLength;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<t;n+=8)m(e,n,n+7),m(e,n+1,n+6),m(e,n+2,n+5),m(e,n+3,n+4);return e},toBuffer:function(e){return e},toString:function(e,t,n=0,r=e.byteLength){const i=e.byteLength;return n>=i||r<=n?"":(n<0&&(n=0),r>i&&(r=i),(0!==n||r<i)&&(e=e.subarray(n,r)),f(t).toString(e))},write:function(e,t,n,r,i){return void 0===n?i="utf8":void 0===r&&"string"==typeof n?(i=n,n=void 0):void 0===i&&"string"==typeof r&&(i=r,r=void 0),f(i).write(e,t,n,r)},writeDoubleLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat64(n,t,!0),n+8},writeFloatLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat32(n,t,!0),n+4},writeUInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setUint32(n,t,!0),n+4},writeInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setInt32(n,t,!0),n+4},readDoubleLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat64(t,!0)},readFloatLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat32(t,!0)},readUInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(t,!0)},readInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getInt32(t,!0)}}}(t,t.exports);var w=e(t.exports);const m=(e,t)=>t.some((t=>e instanceof t));let p,L;const k=new WeakMap,v=new WeakMap,D=new WeakMap;let x={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return k.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return I(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function S(e){x=e(x)}function E(e){return(L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(N(this),t),I(this.request)}:function(...t){return I(e.apply(N(this),t))}}function B(e){return"function"==typeof e?E(e):(e instanceof IDBTransaction&&function(e){if(k.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),r()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)}));k.set(e,t)}(e),m(e,p||(p=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,x):e)}function I(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(I(e.result)),r()},o=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)}));return D.set(t,e),t}(e);if(v.has(e))return v.get(e);const t=B(e);return t!==e&&(v.set(e,t),D.set(t,e)),t}const N=e=>D.get(e);function C(e,t,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const a=indexedDB.open(e,t),s=I(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(I(a.result),e.oldVersion,e.newVersion,I(a.transaction),e)})),n&&a.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),s.then((e=>{o&&e.addEventListener("close",(()=>o())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}const z=["get","getKey","getAll","getAllKeys","count"],A=["put","add","delete","clear"],M=new Map;function q(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(M.get(t))return M.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=A.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!z.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let a=o.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),i&&o.done]))[0]};return M.set(t,o),o}S((e=>({...e,get:(t,n,r)=>q(t,n)||e.get(t,n,r),has:(t,n)=>!!q(t,n)||e.has(t,n)})));const O=["continue","continuePrimaryKey","advance"],U={},T=new WeakMap,$=new WeakMap,V={get(e,t){if(!O.includes(t))return e[t];let n=U[t];return n||(n=U[t]=function(...e){T.set(this,$.get(this)[t](...e))}),n}};async function*P(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,V);for($.set(n,t),D.set(n,N(t));t;)yield n,t=await(T.get(n)||t.continue()),T.delete(n)}function R(e,t){return t===Symbol.asyncIterator&&m(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&m(e,[IDBIndex,IDBObjectStore])}S((e=>({...e,get:(t,n,r)=>R(t,n)?P:e.get(t,n,r),has:(t,n)=>R(t,n)||e.has(t,n)})));class _{constructor(){this.db=null}static getInstance(){return _.instance||(_.instance=new _),_.instance}async _openMetaDB(){return this.db||(this.db=await C("###meta",1,{upgrade(e){const t=e.createObjectStore("meta",{keyPath:"fileName",autoIncrement:!1});t.createIndex("length","length"),t.createIndex("type","type"),t.createIndex("chunkSize","chunkSize")}})),this.db}async get(e){const t=(await this._openMetaDB()).transaction("meta","readonly"),n=t.objectStore("meta");if(!e)throw new Error("fileName is required for retrieving metadata");console.log(`Retrieving metadata for fileName: ${e}`);const r=await n.get(e);return await t.done,r?console.log(`Retrieved metadata for ${e}:`,r):console.warn(`No metadata found for fileName: ${e}`),r}async set(e){if(!e||!e.fileName)throw new Error("fileName is required in the metadata");console.log(`Setting metadata for ${e.fileName}:`,e);const t=(await this._openMetaDB()).transaction("meta","readwrite"),n=t.objectStore("meta");await n.put(e),await t.done,console.log(`Metadata set successfully for ${e.fileName}`,e)}async del(e){const t=(await this._openMetaDB()).transaction("meta","readwrite"),n=t.objectStore("meta");if(!e)throw new Error("fileName is required for deleting metadata");await n.delete(e),await t.done}}const j=_.getInstance();var F={exports:{}};var Q=function(e){var t=new e,n=t;return{get:function(){var r=t;return r.next?t=r.next:(t=new e,n=t),r.next=null,r},release:function(e){n.next=e,n=e}}};function H(e,t,n){if("function"==typeof e&&(n=t,t=e,e=null),!(n>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");var r=Q(K),i=null,o=null,a=0,s=null,c={push:function(l,f){var h=r.get();h.context=e,h.release=u,h.value=l,h.callback=f||W,h.errorHandler=s,a>=n||c.paused?o?(o.next=h,o=h):(i=h,o=h,c.saturated()):(a++,t.call(e,h.value,h.worked))},drain:W,saturated:W,pause:function(){c.paused=!0},paused:!1,get concurrency(){return n},set concurrency(e){if(!(e>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");if(n=e,!c.paused)for(;i&&a<n;)a++,u()},running:function(){return a},resume:function(){if(!c.paused)return;for(c.paused=!1;i&&a<n;)a++,u()},idle:function(){return 0===a&&0===c.length()},length:function(){var e=i,t=0;for(;e;)e=e.next,t++;return t},getQueue:function(){var e=i,t=[];for(;e;)t.push(e.value),e=e.next;return t},unshift:function(l,f){var h=r.get();h.context=e,h.release=u,h.value=l,h.callback=f||W,h.errorHandler=s,a>=n||c.paused?i?(h.next=i,i=h):(i=h,o=h,c.saturated()):(a++,t.call(e,h.value,h.worked))},empty:W,kill:function(){i=null,o=null,c.drain=W},killAndDrain:function(){i=null,o=null,c.drain(),c.drain=W},error:function(e){s=e}};return c;function u(s){s&&r.release(s);var u=i;u&&a<=n?c.paused?a--:(o===i&&(o=null),i=u.next,u.next=null,t.call(e,u.value,u.worked),null===o&&c.empty()):0==--a&&c.drain()}}function W(){}function K(){this.value=null,this.callback=W,this.next=null,this.release=W,this.context=null,this.errorHandler=null;var e=this;this.worked=function(t,n){var r=e.callback,i=e.errorHandler,o=e.value;e.value=null,e.callback=W,e.errorHandler&&i(t,o),r.call(e.context,t,n),e.release(e)}}F.exports=H;var G=F.exports.promise=function(e,t,n){"function"==typeof e&&(n=t,t=e,e=null);var r=H(e,(function(e,n){t.call(this,e).then((function(e){n(null,e)}),n)}),n),i=r.push,o=r.unshift;return r.push=function(e){var t=new Promise((function(t,n){i(e,(function(e,r){e?n(e):t(r)}))}));return t.catch(W),t},r.unshift=function(e){var t=new Promise((function(t,n){o(e,(function(e,r){e?n(e):t(r)}))}));return t.catch(W),t},r.drained=function(){if(r.idle())return new Promise((function(e){e()}));var e=r.drain;return new Promise((function(t){r.drain=function(){e(),t()}}))},r};class J{constructor(){this.queue=null,this._initQueue()}_initQueue(){this.queue||(this.queue=G((async e=>{try{return await e.execute()}catch(t){throw console.error("Task failed:",t),e.callback&&e.callback(t),t}}),1))}addTask(e){return new Promise(((t,n)=>{if(this.queueCleared)return console.warn("Task not added: queue was cleared."),t();this.queue.push({execute:e,callback:(e,r)=>{e?n(e):t(r)}})}))}clearQueue(){console.log("Clearing the task queue"),this.queueCleared=!0,this.queue.kill(),this._initQueue()}pauseQueue(){this.queue.pause()}resumeQueue(){this.queue.resume()}get isPaused(){return this.queue.paused}}var X={exports:{}};function Y(){}Y.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var r=this;function i(){r.off(e,i),t.apply(n,arguments)}return i._=t,this.on(e,i,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,i=n.length;r<i;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],i=[];if(r&&t)for(var o=0,a=r.length;o<a;o++)r[o].fn!==t&&r[o].fn._!==t&&i.push(r[o]);return i.length?n[e]=i:delete n[e],this}},X.exports=Y,X.exports.TinyEmitter=Y;var Z=e(X.exports);class ee extends Z{constructor(e,t={}){super(),this.suspended=!1,this.opened=!1,this.closed=!0,this.meta={chunkSize:4096,...t,fileName:e,length:0},this.queue=new J,this.metaManager=j,this._initializeDB()}async _initializeDB(){if(this.db&&this.opened&&!this.closed)console.log("Database is already initialized and open.");else try{this.db=await ne(this.fileName,{chunkSize:this.chunkSize}),console.log(`Database for file ${this.fileName} opened successfully.`);const e=await this.metaManager.get(this.fileName);this.meta=e||{fileName:this.fileName,chunkSize:this.chunkSize,length:0},this.opened=!0,this.closed=!1}catch(e){console.error(`Failed to open database for ${this.fileName}:`,e)}}async ready(){this.opened||await this._initializeDB()}async ensureDBReady(){this.opened&&!this.closed||await this._initializeDB(),this.db||(console.warn("Database has been purged. Reinitializing as a new file."),await this._initializeDB())}get fileName(){return this.meta.fileName}get chunkSize(){return this.meta.chunkSize}get length(){return this.meta.length}open(e=(()=>{})){this.ready().then((async t=>{this.db=t;const n=await j.get(this.fileName);this.meta=n||{fileName:this.fileName,chunkSize:this.chunkSize,length:0},this.opened=!0,this.closed=!1,e(null)})).catch((t=>e(t)))}write(e,t,n=(()=>{})){this.queue.addTask((async()=>{await this.ensureDBReady();const r=this._blocks(e,e+t.length);console.log("Calculated blocks for write:",r);const i=this.db.transaction("chunks","readwrite"),o=i.objectStore("chunks");let a=0;for(const{block:e,start:n,end:i}of r){const r=await o.get(e)||{data:w.alloc(this.chunkSize)},s=i-n;w.copy(w.from(t),r.data,n,a,a+s),await o.put({chunk:e,data:r.data}),a+=s}await i.done;const s=Math.max(this.meta.length,e+t.length);this.meta.length=s,await this.metaManager.set(this.meta),n(null)})).catch(n)}read(e,t,n=(()=>{})){this.queue.addTask((async()=>{await this.ensureDBReady();const r=this.meta.length;if(e+t>r){const e=new Error(`ENOENT: no such file or directory, open '${this.fileName}'`);return e.code="ENOENT",n(e)}const i=this._blocks(e,e+t),o=this.db.transaction("chunks","readonly"),a=o.objectStore("chunks"),s=[];for(const{block:e,start:t,end:n}of i){const r=await a.get(e);r&&r.data?s.push(r.data.slice(t,n)):s.push(w.alloc(n-t,0))}await o.done;const c=s.length?w.concat(s):w.alloc(0);n(null,c)})).catch(n)}del(e,t,n=(()=>{})){this.queue.addTask((async()=>{await this.ensureDBReady();const r=await this.metaManager.get(this.fileName);if(this.meta=r||{fileName:this.fileName,chunkSize:this.chunkSize,length:0},console.log(`Current file length before deletion: ${this.meta.length}`),t===1/0&&(t=this.meta.length-e),e>=this.meta.length||t<=0)return console.warn(`Invalid range: offset ${e}, size ${t}, length ${this.meta.length}`),n(new Error("Invalid range for deletion"));const i=e+t;if(i>=this.meta.length)return console.log(`Deferring deletion to truncate at offset ${e}`),this.truncate(e,n);const o=this._blocks(e,i);console.log("Calculated blocks for deletion:",o);const a=this.db.transaction("chunks","readwrite"),s=a.objectStore("chunks"),[{block:c,start:u,end:l}]=o,f=await s.get(c);if(f&&f.data){const e=f.data.slice(0,u),t=w.alloc(l-u,0),n=f.data.slice(l),r=w.concat([e,t,n]);await s.put({chunk:c,data:r})}for(const{block:e}of o.slice(1))await s.put({chunk:e,data:w.alloc(this.chunkSize)});await a.done;const h=Math.max(this.meta.length,e+t);this.meta.length=h,await this.metaManager.set(this.meta),console.log(`Deletion complete. File length is now ${h}`),n(null)})).catch(n)}close(e=(()=>{})){this.queue.addTask((async()=>{try{await this.ensureDBReady(),this.db=null,this.meta=null,this.queue=null,console.log("File closed successfully"),this.emit("close"),e(null)}catch(t){console.error("Error during close:",t.message),e(t)}})).catch(e)}truncate(e,t=(()=>{})){this.queue.addTask((async()=>{await this.ensureDBReady();const n=this.meta.length;if(e>n)return this.write(n,w.alloc(e-n),t);const r=this._blocks(e,n),i=this.db.transaction("chunks","readwrite"),o=i.objectStore("chunks");for(const{block:e}of r.slice(1))await o.delete(e);const[{block:a,start:s}]=r,c=await o.get(a);if(c&&c.data){const e=w.alloc(c.data.length);w.copy(c.data,e,0,0,s),await o.put({chunk:a,data:e})}await i.done,this.meta.length=e,await this.metaManager.set(this.meta),t(null)})).catch(t)}stat(e=(()=>{})){this.queue.addTask((async()=>{let t;await this.ensureDBReady(),this.meta&&this.meta.fileName&&0!==this.meta.length||(t=new Error("File does not exist"),t.code="ENOENT",console.error("Error in stat:",t.message));const n={length:this.meta.length,size:this.meta.length,chunkSize:this.meta.chunkSize,fileName:this.meta.fileName};e(t,n)})).catch(e)}suspend(e=(()=>{})){this.queue.pauseQueue(),this.suspended=!0,setTimeout((()=>{this.emit("suspend"),e()}),0)}purge(e=(()=>{})){console.log("Queueing purge operation"),this.queue.addTask((async()=>{await this.ensureDBReady().catch((e=>!1));try{console.log(`Purging file ${this.fileName}`),await function(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",(e=>t(e.oldVersion,e))),I(n).then((()=>{}))}(this.fileName),await this.metaManager.del(this.fileName),this.db=null,this.meta={fileName:this.fileName,chunkSize:this.chunkSize,length:0},te.delete(this.fileName),console.log(`Removed ${this.fileName} from allLoadedFiles`),console.log(`Purge complete for file ${this.fileName}`)}catch(t){e(null)}e(null)})).catch(e)}_blocks(e,t){return function(e,t,n){const r=[];for(let i=Math.floor(t/e)*e;i<n;i+=e)r.push({block:Math.floor(i/e),start:Math.max(i,t)%e,end:Math.min(i+e,n)%e||e});return r}(this.chunkSize,e,t)}}const te=new Map;async function ne(e,t={}){const{openBlockingHandler:n=((t,n,r)=>{console.warn(`Database ${e} is blocking the upgrade (currentVersion: ${t}, blockedVersion: ${n}). Closing this connection.`),r.target.close()}),openBlockedHandler:r=(t=>{console.warn(`Database ${e} is blocked by an existing connection. Closing this connection.`),t.target.close()})}=t;return await C(e,void 0,{upgrade(e){e.createObjectStore("chunks",{keyPath:"chunk",autoIncrement:!1}).createIndex("data","data")},blocking(e,t,r){n?.(e,t,r)},blocked(...e){r?.(...e)}})}function re(e,t={}){const{chunkSize:n=4096,directory:r=""}=t;if(r&&(e=`${r}/${e}`),te.has(e)){const t=te.get(e);if(!t.closed)return t;te.delete(e)}const i=new ee(e,{chunkSize:n});return te.set(e,i),i}export{te as allLoadedFiles,re as createFile,re as default,ne as openFile};

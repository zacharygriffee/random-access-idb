function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}globalThis.process={platform:"browser"};var t,n={exports:{}},r="object"==typeof Reflect?Reflect:null,o=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}n.exports=s,n.exports.once=function(e,t){return new Promise((function(n,r){function o(n){e.removeListener(t,i),r(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",o),n([].slice.call(arguments))}y(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&y(e,"error",t,n)}(e,o,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var o,i,s,a;if(u(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),s=i[t]),void 0===s)s=i[t]=n,++e._eventsCount;else if("function"==typeof s?s=i[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(o=c(e))>0&&s.length>o&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=s.length,a=l,console&&console.warn&&console.warn(a)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=f.bind(r);return o.listener=n,r.wrapFn=o,o}function d(e,t,n){var r=e._events;if(void 0===r)return[];var o=r[t];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(o):g(o,o.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function y(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function o(i){r.once&&e.removeEventListener(t,o),n(i)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=i[e];if(void 0===u)return!1;if("function"==typeof u)o(u,this,t);else{var c=u.length,l=g(u,c);for(n=0;n<c;++n)o(l[n],this,t)}return!0},s.prototype.addListener=function(e,t){return l(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return l(this,e,t,!0)},s.prototype.once=function(e,t){return u(t),this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,o,i,s;if(u(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){s=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,o),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var o,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return d(this,e,!0)},s.prototype.rawListeners=function(e){return d(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},s.prototype.listenerCount=p,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};var b=n.exports,w="function"==typeof queueMicrotask?queueMicrotask:e=>Promise.resolve().then(e);const v=b,m=w,L=D(new Error("Not readable")),k=D(new Error("Not writable")),_=D(new Error("Not deletable")),x=D(new Error("Not statable")),E=D(null),O=D(null),I=D(null);var S=class e extends v{constructor(t){super(),this._queued=[],this._pending=0,this._needsOpen=!0,this.opened=!1,this.suspended=!1,this.closed=!1,this.unlinked=!1,this.writing=!1,t&&(t.open&&(this._open=t.open),t.read&&(this._read=t.read),t.write&&(this._write=t.write),t.del&&(this._del=t.del),t.truncate&&(this._truncate=t.truncate),t.stat&&(this._stat=t.stat),t.suspend&&(this._suspend=t.suspend),t.close&&(this._close=t.close),t.unlink&&(this._unlink=t.unlink)),this.readable=this._read!==e.prototype._read,this.writable=this._write!==e.prototype._write,this.deletable=this._del!==e.prototype._del,this.truncatable=this._truncate!==e.prototype._truncate||this.deletable,this.statable=this._stat!==e.prototype._stat}read(e,t,n){this.run(new C(this,0,e,t,null,n),!1)}_read(e){return L(e)}write(e,t,n){n||(n=j),this.run(new C(this,1,e,t.length,t,n),!0)}_write(e){return k(e)}del(e,t,n){n||(n=j),this.run(new C(this,2,e,t,null,n),!0)}_del(e){return _(e)}truncate(e,t){t||(t=j),this.run(new C(this,3,e,0,null,t),!0)}_truncate(e){e.size=1/0,this._del(e)}stat(e){this.run(new C(this,4,0,0,null,e),!1)}_stat(e){return x(e)}open(e){if(e||(e=j),this.opened&&!this._needsOpen)return N(e);this._needsOpen=!1,A(this,new C(this,5,0,0,null,e))}_open(e){return E(e)}suspend(e){if(e||(e=j),this.closed||this.suspended)return N(e);this._needsOpen=!0,A(this,new C(this,6,0,0,null,e))}_suspend(e){this._close(e)}close(e){if(e||(e=j),this.closed)return N(e);A(this,new C(this,7,0,0,null,e))}_close(e){return O(e)}unlink(e){e||(e=j),this.closed||this.close(j),A(this,new C(this,8,0,0,null,e))}_unlink(e){return I(e)}run(e,t){t&&!this.writing&&(this.writing=!0,this._needsOpen=!0),this._needsOpen&&this.open(j),this._queued.length?this._queued.push(e):e._run()}};class C{constructor(e,t,n,r,o,i){this.type=t,this.offset=n,this.size=r,this.data=o,this.storage=e,this._sync=!1,this._callback=i,this._openError=null}_maybeOpenError(e){if(5!==this.type)return;const t=this.storage._queued;for(let n=1;n<t.length;n++){const r=t[n];if(5===r.type)break;r._openError=e}}_unqueue(e){const t=this.storage,n=t._queued;if(e)this._maybeOpenError(e);else if(this.type>4)switch(this.type){case 5:t.suspended&&(t.suspended=!1,t.emit("unsuspend")),t.opened||(t.opened=!0,t.emit("open"));break;case 6:t.suspended||(t.suspended=!0,t.emit("suspend"));break;case 7:t.closed||(t.closed=!0,t.emit("close"));break;case 8:t.unlinked||(t.unlinked=!0,t.emit("unlink"))}n.length&&n[0]===this&&n.shift(),--t._pending||function(e){const t=e._queued;for(;t.length>0;){const n=t[0].type>4;if(n&&e._pending||t[0]._run(),n)return;t.shift()}}(t)}callback(e,t){if(this._sync)return B(this,e,t);this._unqueue(e),this._callback(e,t)}_openAndNotClosed(){const e=this.storage;return!(!e.opened||e.closed||e.suspended)||(!e.opened||e.suspended?B(this,this._openError||new Error("Not opened")):e.closed&&B(this,new Error("Closed")),!1)}_open(){const e=this.storage;return e.opened&&!e.suspended?B(this,null):e.closed?B(this,new Error("Closed")):void e._open(this)}_run(){const e=this.storage;switch(e._pending++,this._sync=!0,this.type){case 0:this._openAndNotClosed()&&e._read(this);break;case 1:this._openAndNotClosed()&&e._write(this);break;case 2:this._openAndNotClosed()&&e._del(this);break;case 3:this._openAndNotClosed()&&e._truncate(this);break;case 4:this._openAndNotClosed()&&e._stat(this);break;case 5:this._open();break;case 6:e.closed||!e.opened||e.suspended?B(this,null):e._suspend(this);break;case 7:e.closed||!e.opened||e.suspended?B(this,null):e._close(this);break;case 8:e.unlinked?B(this,null):e._unlink(this)}this._sync=!1}}function A(e,t){e._queued.push(t),e._pending||t._run()}function D(e){return function(t){B(t,e)}}function B(e,t,n){m((()=>e.callback(t,n)))}function N(e){m((()=>e(null)))}function j(){}var z=e(S);var M={exports:{}};function P(e){return e.length}var U={byteLength:P,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r++)n+=String.fromCharCode(e[r]);return n},write:function(e,t,n=0,r=P(t)){const o=Math.min(r,e.byteLength-n);for(let r=0;r<o;r++)e[n+r]=t.charCodeAt(r);return o}};const q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",V=new Uint8Array(256);for(let e=0;e<64;e++)V[q.charCodeAt(e)]=e;function R(e){let t=e.length;return 61===e.charCodeAt(t-1)&&t--,t>1&&61===e.charCodeAt(t-1)&&t--,3*t>>>2}V[45]=62,V[95]=63;var T={byteLength:R,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r+=3)n+=q[e[r]>>2]+q[(3&e[r])<<4|e[r+1]>>4]+q[(15&e[r+1])<<2|e[r+2]>>6]+q[63&e[r+2]];return t%3==2?n=n.substring(0,n.length-1)+"=":t%3==1&&(n=n.substring(0,n.length-2)+"=="),n},write:function(e,t,n=0,r=R(t)){const o=Math.min(r,e.byteLength-n);for(let n=0,r=0;r<o;n+=4){const o=V[t.charCodeAt(n)],i=V[t.charCodeAt(n+1)],s=V[t.charCodeAt(n+2)],a=V[t.charCodeAt(n+3)];e[r++]=o<<2|i>>4,e[r++]=(15&i)<<4|s>>2,e[r++]=(3&s)<<6|63&a}return o}};function H(e){return e.length>>>1}var F={byteLength:H,toString:function(e){const t=e.byteLength;e=new DataView(e.buffer,e.byteOffset,t);let n="",r=0;for(let o=t-t%4;r<o;r+=4)n+=e.getUint32(r).toString(16).padStart(8,"0");for(;r<t;r++)n+=e.getUint8(r).toString(16).padStart(2,"0");return n},write:function(e,t,n=0,r=H(t)){const o=Math.min(r,e.byteLength-n);for(let r=0;r<o;r++){const o=K(t.charCodeAt(2*r)),i=K(t.charCodeAt(2*r+1));if(void 0===o||void 0===i)return e.subarray(0,r);e[n+r]=o<<4|i}return o}};function K(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-65+10:e>=97&&e<=102?e-97+10:void 0}function W(e){let t=0;for(let n=0,r=e.length;n<r;n++){const o=e.charCodeAt(n);if(o>=55296&&o<=56319&&n+1<r){const r=e.charCodeAt(n+1);if(r>=56320&&r<=57343){t+=4,n++;continue}}t+=o<=127?1:o<=2047?2:3}return t}let Y,Q;if("undefined"!=typeof TextDecoder){const e=new TextDecoder;Y=function(t){return e.decode(t)}}else Y=function(e){const t=e.byteLength;let n="",r=0;for(;r<t;){let o=e[r];if(o<=127){n+=String.fromCharCode(o),r++;continue}let i=0,s=0;if(o<=223?(i=1,s=31&o):o<=239?(i=2,s=15&o):o<=244&&(i=3,s=7&o),t-r-i>0){let t=0;for(;t<i;)o=e[r+t+1],s=s<<6|63&o,t+=1}else s=65533,i=t-r;n+=String.fromCodePoint(s),r+=i+1}return n};if("undefined"!=typeof TextEncoder){const e=new TextEncoder;Q=function(t,n,r=0,o=W(n)){const i=Math.min(o,t.byteLength-r);return e.encodeInto(n,t.subarray(r,r+i)),i}}else Q=function(e,t,n=0,r=W(t)){const o=Math.min(r,e.byteLength-n);e=e.subarray(n,n+o);let i=0,s=0;for(;i<t.length;){const n=t.codePointAt(i);if(n<=127){e[s++]=n,i++;continue}let r=0,o=0;for(n<=2047?(r=6,o=192):n<=65535?(r=12,o=224):n<=2097151&&(r=18,o=240),e[s++]=o|n>>r,r-=6;r>=0;)e[s++]=128|n>>r&63,r-=6;i+=n>=65536?2:1}return o};var $={byteLength:W,toString:Y,write:Q};function G(e){return 2*e.length}var J={byteLength:G,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t-1;r+=2)n+=String.fromCharCode(e[r]+256*e[r+1]);return n},write:function(e,t,n=0,r=G(t)){const o=Math.min(r,e.byteLength-n);let i=o;for(let r=0;r<t.length&&!((i-=2)<0);++r){const o=t.charCodeAt(r),i=o>>8,s=o%256;e[n+2*r]=s,e[n+2*r+1]=i}return o}};!function(e,t){const n=U,r=T,o=F,i=$,s=J,a=255===new Uint8Array(Uint16Array.of(255).buffer)[0];function u(e){switch(e){case"ascii":return n;case"base64":return r;case"hex":return o;case"utf8":case"utf-8":case void 0:return i;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return s;default:throw new Error(`Unknown encoding: ${e}`)}}function c(e){return e instanceof Uint8Array}function l(e,t,n){return"string"==typeof e?function(e,t){const n=u(t),r=new Uint8Array(n.byteLength(e));return n.write(r,e,0,r.byteLength),r}(e,t):Array.isArray(e)?function(e){const t=new Uint8Array(e.length);return t.set(e),t}(e):ArrayBuffer.isView(e)?function(e){const t=new Uint8Array(e.byteLength);return t.set(e),t}(e):function(e,t,n){return new Uint8Array(e,t,n)}(e,t,n)}function f(e,t,n,r,o){if(0===e.byteLength)return-1;if("string"==typeof n?(r=n,n=0):void 0===n?n=o?0:e.length-1:n<0&&(n+=e.byteLength),n>=e.byteLength){if(o)return-1;n=e.byteLength-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof t)t=l(t,r);else if("number"==typeof t)return t&=255,o?e.indexOf(t,n):e.lastIndexOf(t,n);if(0===t.byteLength)return-1;if(o){let r=-1;for(let o=n;o<e.byteLength;o++)if(e[o]===t[-1===r?0:o-r]){if(-1===r&&(r=o),o-r+1===t.byteLength)return r}else-1!==r&&(o-=o-r),r=-1}else{n+t.byteLength>e.byteLength&&(n=e.byteLength-t.byteLength);for(let r=n;r>=0;r--){let n=!0;for(let o=0;o<t.byteLength;o++)if(e[r+o]!==t[o]){n=!1;break}if(n)return r}}return-1}function h(e,t,n,r){return f(e,t,n,r,!0)}function d(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}e.exports=t={isBuffer:c,isEncoding:function(e){try{return u(e),!0}catch{return!1}},alloc:function(e,n,r){const o=new Uint8Array(e);return void 0!==n&&t.fill(o,n,0,o.byteLength,r),o},allocUnsafe:function(e){return new Uint8Array(e)},allocUnsafeSlow:function(e){return new Uint8Array(e)},byteLength:function(e,t){return u(t).byteLength(e)},compare:function(e,t){if(e===t)return 0;const n=Math.min(e.byteLength,t.byteLength);e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let o=n-n%4;r<o;r+=4){if(e.getUint32(r,a)!==t.getUint32(r,a))break}for(;r<n;r++){const n=e.getUint8(r),o=t.getUint8(r);if(n<o)return-1;if(n>o)return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0},concat:function(e,t){void 0===t&&(t=e.reduce(((e,t)=>e+t.byteLength),0));const n=new Uint8Array(t);let r=0;for(const t of e){if(r+t.byteLength>n.byteLength){const e=t.subarray(0,n.byteLength-r);return n.set(e,r),n}n.set(t,r),r+=t.byteLength}return n},copy:function(e,t,n=0,r=0,o=e.byteLength){if(o>0&&o<r)return 0;if(o===r)return 0;if(0===e.byteLength||0===t.byteLength)return 0;if(n<0)throw new RangeError("targetStart is out of range");if(r<0||r>=e.byteLength)throw new RangeError("sourceStart is out of range");if(o<0)throw new RangeError("sourceEnd is out of range");n>=t.byteLength&&(n=t.byteLength),o>e.byteLength&&(o=e.byteLength),t.byteLength-n<o-r&&(o=t.length-n+r);const i=o-r;return e===t?t.copyWithin(n,r,o):t.set(e.subarray(r,o),n),i},equals:function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const n=e.byteLength;e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let o=n-n%4;r<o;r+=4)if(e.getUint32(r,a)!==t.getUint32(r,a))return!1;for(;r<n;r++)if(e.getUint8(r)!==t.getUint8(r))return!1;return!0},fill:function(e,t,n,r,o){if("string"==typeof t?"string"==typeof n?(o=n,n=0,r=e.byteLength):"string"==typeof r&&(o=r,r=e.byteLength):"number"==typeof t?t&=255:"boolean"==typeof t&&(t=+t),n<0||e.byteLength<n||e.byteLength<r)throw new RangeError("Out of range index");if(void 0===n&&(n=0),void 0===r&&(r=e.byteLength),r<=n)return e;if(t||(t=0),"number"==typeof t)for(let o=n;o<r;++o)e[o]=t;else{const i=(t=c(t)?t:l(t,o)).byteLength;for(let o=0;o<r-n;++o)e[o+n]=t[o%i]}return e},from:l,includes:function(e,t,n,r){return-1!==h(e,t,n,r)},indexOf:h,lastIndexOf:function(e,t,n,r){return f(e,t,n,r,!1)},swap16:function(e){const t=e.byteLength;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<t;n+=2)d(e,n,n+1);return e},swap32:function(e){const t=e.byteLength;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<t;n+=4)d(e,n,n+3),d(e,n+1,n+2);return e},swap64:function(e){const t=e.byteLength;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<t;n+=8)d(e,n,n+7),d(e,n+1,n+6),d(e,n+2,n+5),d(e,n+3,n+4);return e},toBuffer:function(e){return e},toString:function(e,t,n=0,r=e.byteLength){const o=e.byteLength;return n>=o||r<=n?"":(n<0&&(n=0),r>o&&(r=o),(0!==n||r<o)&&(e=e.subarray(n,r)),u(t).toString(e))},write:function(e,t,n,r,o){return void 0===n?o="utf8":void 0===r&&"string"==typeof n?(o=n,n=void 0):void 0===o&&"string"==typeof r&&(o=r,r=void 0),u(o).write(e,t,n,r)},writeDoubleLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat64(n,t,!0),n+8},writeFloatLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat32(n,t,!0),n+4},writeUInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setUint32(n,t,!0),n+4},writeInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setInt32(n,t,!0),n+4},readDoubleLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat64(t,!0)},readFloatLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat32(t,!0)},readUInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(t,!0)},readInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getInt32(t,!0)}}}(M,M.exports);var X=e(M.exports);const Z=(e,t)=>t.some((t=>e instanceof t));let ee,te;const ne=new WeakMap,re=new WeakMap,oe=new WeakMap;let ie={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return ne.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ce(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function se(e){ie=e(ie)}function ae(e){return(te||(te=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(le(this),t),ce(this.request)}:function(...t){return ce(e.apply(le(this),t))}}function ue(e){return"function"==typeof e?ae(e):(e instanceof IDBTransaction&&function(e){if(ne.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),r()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)}));ne.set(e,t)}(e),Z(e,ee||(ee=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,ie):e)}function ce(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(ce(e.result)),r()},i=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",i)}));return oe.set(t,e),t}(e);if(re.has(e))return re.get(e);const t=ue(e);return t!==e&&(re.set(e,t),oe.set(t,e)),t}const le=e=>oe.get(e);function fe(e,t,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){const s=indexedDB.open(e,t),a=ce(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(ce(s.result),e.oldVersion,e.newVersion,ce(s.transaction),e)})),n&&s.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}const he=["get","getKey","getAll","getAllKeys","count"],de=["put","add","delete","clear"],pe=new Map;function ge(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(pe.get(t))return pe.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=de.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!he.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let s=i.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),o&&i.done]))[0]};return pe.set(t,i),i}se((e=>({...e,get:(t,n,r)=>ge(t,n)||e.get(t,n,r),has:(t,n)=>!!ge(t,n)||e.has(t,n)})));const ye=["continue","continuePrimaryKey","advance"],be={},we=new WeakMap,ve=new WeakMap,me={get(e,t){if(!ye.includes(t))return e[t];let n=be[t];return n||(n=be[t]=function(...e){we.set(this,ve.get(this)[t](...e))}),n}};async function*Le(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,me);for(ve.set(n,t),oe.set(n,le(t));t;)yield n,t=await(we.get(n)||t.continue()),we.delete(n)}function ke(e,t){return t===Symbol.asyncIterator&&Z(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&Z(e,[IDBIndex,IDBObjectStore])}se((e=>({...e,get:(t,n,r)=>ke(t,n)?Le:e.get(t,n,r),has:(t,n)=>ke(t,n)||e.has(t,n)})));const _e=Ee(!1),xe=Ee(!0);function Ee(e){const t={};t.posix=t,t.win32=t;const n=t.sep=e?"\\":"/";return e?(t.isAbsolute=function(e){return 0!==e.length&&("\\"===e[0]||"/"===e[0]||2===e.length&&":"===e[1]||e.length>2&&":"===e[1]&&("\\"===e[2]||"/"===e[2]))},t.root=function(e){return 0===e.length?"":"\\"===e[0]||"/"===e[0]?e[0]:2===e.length&&":"===e[1]?e:e.length>2&&":"===e[1]&&("\\"===e[2]||"/"===e[2])?e.slice(0,3):""}):(t.isAbsolute=function(e){return e.length>0&&"/"===e[0]},t.root=function(e){return t.isAbsolute(e)?"/":""}),t.basename=function(e){let t=e.length-1;for(;t>0&&e[t]===n;)t--;return t<=0?"":e.slice(e.lastIndexOf(n,t)+1,t+1)},t.dirname=function(e){let t=e.length-1;for(;t>0&&e[t]===n;)t--;if(t<=0)return"";const r=e.lastIndexOf(n,t);return-1===r?"":e.slice(0,r)},t.extname=function(e){const t=e.lastIndexOf(".");return-1===t?"":e.slice(t)},t.resolve=function(e,n){return void 0===n?t.normalize(e):t.isAbsolute(n)?t.normalize(n):t.join(e,n)},t.join=function(e,...r){for(const t of r)e+=n+t;return t.normalize(e)},t.normalize=function(r){if(!0===e){let e=-1;for(;-1!==(e=r.indexOf("/",e+1));)r=r.slice(0,e)+n+r.slice(e+1)}const o=t.root(r),i=""!==o;let s=o.length,a="";for(;s<r.length;){let e=r.indexOf(n,s);-1===e&&(e=r.length);const t=r.slice(s,e);if(s=e+1,""!==t&&"."!==t)if(".."!==t)a+=a?n+t:t;else{const e=a.lastIndexOf(n);-1===e||".."===a.slice(e+1)?i?a="":a+=a?n+"..":"..":a=a.slice(0,e)}}return o&&(a=o+a),a||"."},t}_e.win32=xe,xe.posix=_e;var Oe=e("win32"===process.platform?xe:_e),Ie={exports:{}},Se=function(e){var t=new e,n=t;return{get:function(){var r=t;return r.next?t=r.next:(t=new e,n=t),r.next=null,r},release:function(e){n.next=e,n=e}}};function Ce(e,t,n){if("function"==typeof e&&(n=t,t=e,e=null),!(n>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");var r=Se(De),o=null,i=null,s=0,a=null,u={push:function(l,f){var h=r.get();h.context=e,h.release=c,h.value=l,h.callback=f||Ae,h.errorHandler=a,s>=n||u.paused?i?(i.next=h,i=h):(o=h,i=h,u.saturated()):(s++,t.call(e,h.value,h.worked))},drain:Ae,saturated:Ae,pause:function(){u.paused=!0},paused:!1,get concurrency(){return n},set concurrency(e){if(!(e>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");if(n=e,!u.paused)for(;o&&s<n;)s++,c()},running:function(){return s},resume:function(){if(u.paused)for(u.paused=!1;o&&s<n;)s++,c()},idle:function(){return 0===s&&0===u.length()},length:function(){for(var e=o,t=0;e;)e=e.next,t++;return t},getQueue:function(){for(var e=o,t=[];e;)t.push(e.value),e=e.next;return t},unshift:function(l,f){var h=r.get();h.context=e,h.release=c,h.value=l,h.callback=f||Ae,h.errorHandler=a,s>=n||u.paused?o?(h.next=o,o=h):(o=h,i=h,u.saturated()):(s++,t.call(e,h.value,h.worked))},empty:Ae,kill:function(){o=null,i=null,u.drain=Ae},killAndDrain:function(){o=null,i=null,u.drain(),u.drain=Ae},error:function(e){a=e}};return u;function c(a){a&&r.release(a);var c=o;c&&s<=n?u.paused?s--:(i===o&&(i=null),o=c.next,c.next=null,t.call(e,c.value,c.worked),null===i&&u.empty()):0==--s&&u.drain()}}function Ae(){}function De(){this.value=null,this.callback=Ae,this.next=null,this.release=Ae,this.context=null,this.errorHandler=null;var e=this;this.worked=function(t,n){var r=e.callback,o=e.errorHandler,i=e.value;e.value=null,e.callback=Ae,e.errorHandler&&o(t,i),r.call(e.context,t,n),e.release(e)}}Ie.exports=Ce;var Be=Ie.exports.promise=function(e,t,n){"function"==typeof e&&(n=t,t=e,e=null);var r=Ce(e,(function(e,n){t.call(this,e).then((function(e){n(null,e)}),n)}),n),o=r.push,i=r.unshift;return r.push=function(e){var t=new Promise((function(t,n){o(e,(function(e,r){e?n(e):t(r)}))}));return t.catch(Ae),t},r.unshift=function(e){var t=new Promise((function(t,n){i(e,(function(e,r){e?n(e):t(r)}))}));return t.catch(Ae),t},r.drained=function(){if(r.idle())return new Promise((function(e){e()}));var e=r.drain;return new Promise((function(t){r.drain=function(){e(),t()}}))},r};const Ne=Be((async({task:e,request:t})=>{try{const n=await Promise.resolve(e());t.callback&&await t.callback(null,n)}catch(e){if(t.callback)return t.callback(e);throw e}}),1),je=await fe("###meta",void 0,{upgrade(e){const t=e.createObjectStore("meta",{keyPath:"fileName",autoIncrement:!1});t.createIndex("length","length"),t.createIndex("type","type"),t.createIndex("chunkSize","chunkSize")}});function ze(e){return je.transaction("meta","readonly").objectStore("meta").get(e).catch((e=>!1))}function Me({fileName:e,length:t,...n}={}){const r=je.transaction("meta","readwrite");return r.objectStore("meta").put({fileName:e,length:t||0,...n}),r.done}async function Pe(e,t={},n=!0,r=!0){const o=e.transaction("chunks","readonly").objectStore("chunks");let i;return i=null==t.end?IDBKeyRange.lowerBound(t.start,!r):null==t.start?IDBKeyRange.upperBound(t.end,!n):t.start&&t.end?IDBKeyRange.bound(t.start,t.end,!n,!r):void 0,await o.getAll(i)}async function Ue(e,t=[]){Array.isArray(t)||(t=[t]);const n=e.transaction("chunks","readwrite"),r=n.objectStore("chunks"),o=[];for(const{chunk:e,data:n}of t)o.push(r.put({chunk:e,data:n}));o.push(n.done),await Promise.all(o)}let qe={chunkSize:4096,MapClass:Map};function Ve(e){return Promise.resolve(e(qe)).then((e=>{qe=e}))}let Re=null;function Te(e,t={}){const{size:n,chunkSize:r=n,MapClass:o,openBlockingHandler:i=((e,t,n)=>n.target.close()),openBlockedHandler:s,deleteBlockingHandler:a,prefix:u,directory:c=u}={...qe,...t};if(c&&(e=Oe.join(c,Oe.resolve("/",e).replace(/^\w+:\\/,""))),Re||(Re=new o),Re.has(e))return Re.get(e);t.chunkSize||=r;const l=(async()=>(await ze(e)||await Me({fileName:e,length:0,chunkSize:t.chunkSize}),await async function(e,t={}){const{openBlockingHandler:n,openBlockedHandler:r}=t;if("######meta"===e)throw new Error("Reserved db name");return await fe(e,void 0,{upgrade(e){e.createObjectStore("chunks",{keyPath:"chunk",autoIncrement:!1}).createIndex("data","data")},blocking(e,t,r){n(e,t,r)},blocked(...e){r(...e)}})}(e,{openBlockingHandler:i,openBlockedHandler:s,...t})))(),f=new He({ready:l,fileName:e,...t});return f.deleteBlockingHandler=a,Re.set(e,f),f}class He extends z{length;constructor({ready:e,fileName:t,chunkSize:n}){super(),this.ready=()=>e,this.fileName=t,this.chunkSize=n}async refreshLength(){const e=await ze(this.fileName);this.length=e.length}async setLength(e){return this.length=e,Me({fileName:this.fileName,length:e,chunkSize:this.chunkSize})}async ensureChunkSize(){const e=await ze(this.fileName);e&&e.chunkSize&&(this.chunkSize=e.chunkSize)}open(e){super.open(e)}close(e){super.close(e)}write(e,t,n){super.write(e,t,n)}read(e,t,n){super.read(e,t,n)}del(e,t,n){super.del(e,t,n)}truncate(e,t){super.truncate(e,t)}stat(e){super.stat(e)}async purge(e){const t=this;var n;await new Promise((e=>this.close(e))),await function(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",(e=>t(e.oldVersion,e))),ce(n).then((()=>{}))}(t.fileName,{blocked(...e){t.deleteBlockingHandler&&t.deleteBlockingHandler(...e)}}),await(n=t.fileName,je.transaction("meta","readwrite").objectStore("meta").delete(n).catch((e=>!1))),e?.()}_blocks(e,t){const{chunkSize:n}=this;return function(e,t,n){const r=[];for(let o=Math.floor(t/e)*e;o<n;o+=e)r.push({block:Math.floor(o/e),start:Math.max(o,t)%e,end:Math.min(o+e,n)%e||e});return r}(n,e,t)}async __open(){this.db=await this.ready(),await this.ensureChunkSize(),await this.refreshLength()}async _open(e){try{await this.__open(),e.callback(null,null)}catch(t){e.callback(t)}}_read(e){const t=this;Ne.push({request:e,async task(){await t.__open();let{offset:n,size:r}=e;if(0===r)return X.alloc(0);const{db:o,length:i}=t;if(0===i){const e=new Error("No file");throw e.code="ENOENT",e}if(r===Number.POSITIVE_INFINITY&&(r=i-n),(i||0)<n+r)throw console.error(e,t.fileName),new Error("Could not satisfy length ");const s=t._blocks(n,n+r),[{block:a}]=s,{block:u}=s[s.length-1],c=await Pe(o,{start:a,end:u},!0,!0);let l=0;const f=[];for(const{data:e,chunk:t}of Object.values(c)){if(l=t-a,!s[l])continue;const{start:n,end:r}=s[l];f[l]=X.from(e.slice(n,r))}return X.concat(f)}})}_write(e){const t=this,{chunkSize:n,length:r,db:o}=t,{offset:i,data:s}=e;Ne.push({request:e,async task(){const e=t._blocks(i,i+s.length),[{block:a}]=e,{block:u}=e[e.length-1];let c;const l=await Pe(o,{start:a,end:u},!0,!0);for(let[e,t]of Object.entries(l))l[e]=t?.data;let f=0,h=0;const d=o.transaction("chunks","readwrite"),p=d.objectStore("chunks");for(const{block:t,start:r,end:o}of e){const e=h++,i=o-r;i===n?l[e]=X.from(s.slice(f,f+i)):(l[e]||=X.from(X.alloc(n)),X.copy(X.from(s),l[e],r,f,f+i)),await p.put({chunk:t,data:X.from(l[e])}),f+=i}return c=Math.max(r||0,i+s.length),await d.done,await t.setLength(c),null}})}_del(e){const t=this;let{offset:n,size:r}=e;const{length:o,db:i,chunkSize:s}=this;if(r===Number.POSITIVE_INFINITY&&(r=e.size=o-n),n+r>o&&(r=e.size=Math.max(0,o-n)),n+r>=o)return this._truncate(e);Ne.push({request:e,async task(){const e=t._blocks(n,n+r),o=e.shift(),a=e.pop()||o;a.block-o.block>1&&await Pe(i,{start:o.block,end:a.block},!1,!1);const{0:u,1:c}=await Pe(i,{start:o.block,end:a.block},!0,!0);if(u){const e=c?o.end:o.end-o.start,t=X.alloc(e);X.copy(t,u.data,o.start),await Ue(i,u)}if(c){const e=Math.min(a.end,s),t=X.alloc(e);X.copy(t,c.data,a.start),await Ue(i,c)}}})}_truncate(e){const t=this,{offset:n}=e,{length:r,chunkSize:o,db:i}=this;return n===r?e.callback(null,null):n>r?this.write(r,X.alloc(e.offset-r),(t=>t?e.callback(t,null):e.callback(null,null))):void Ne.push({request:e,async task(){const e=t._blocks(n,r),[{block:s,start:a,end:u}]=e,[c,...l]=await Pe(i,{start:s},!0),f=i.transaction("chunks","readwrite"),h=f.objectStore("chunks");if(l.length>0){const e=[];for(const t of l)e.push(h.delete(t.chunk));await Promise.all(e)}const d=u-a;if(d===o)await h.delete(s);else{let{data:e,chunk:t}=c,n=X.alloc(d);X.copy(n,e,a,a,d),await h.put({chunk:t,data:e})}return await f.done,await t.setLength(n),null}})}_stat(e){const t=this;Ne.push({request:e,async task(){await t.ready();const e=await ze(t.fileName);return{...e,size:e.length}}})}_close(e){const{fileName:t,db:n}=this;Ne.push({async task(){n.close(),Re.delete(t)},request:e})}}export{Re as allLoadedFiles,Te as createFile,Te as default,qe as defaultConfig,Ve as updateDefaultConfig};

function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}globalThis.process={platform:"browser",cwd:()=>""};var t={exports:{}};function n(e){return e.length}var r={byteLength:n,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r++)n+=String.fromCharCode(e[r]);return n},write:function(e,t,r=0,o=n(t)){const i=Math.min(o,e.byteLength-r);for(let n=0;n<i;n++)e[r+n]=t.charCodeAt(n);return i}};const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(256);for(let e=0;e<64;e++)i[o.charCodeAt(e)]=e;function a(e){let t=e.length;return 61===e.charCodeAt(t-1)&&t--,t>1&&61===e.charCodeAt(t-1)&&t--,3*t>>>2}i[45]=62,i[95]=63;var s={byteLength:a,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t;r+=3)n+=o[e[r]>>2]+o[(3&e[r])<<4|e[r+1]>>4]+o[(15&e[r+1])<<2|e[r+2]>>6]+o[63&e[r+2]];return t%3==2?n=n.substring(0,n.length-1)+"=":t%3==1&&(n=n.substring(0,n.length-2)+"=="),n},write:function(e,t,n=0,r=a(t)){const o=Math.min(r,e.byteLength-n);for(let n=0,r=0;r<o;n+=4){const o=i[t.charCodeAt(n)],a=i[t.charCodeAt(n+1)],s=i[t.charCodeAt(n+2)],c=i[t.charCodeAt(n+3)];e[r++]=o<<2|a>>4,e[r++]=(15&a)<<4|s>>2,e[r++]=(3&s)<<6|63&c}return o}};function c(e){return e.length>>>1}var u={byteLength:c,toString:function(e){const t=e.byteLength;e=new DataView(e.buffer,e.byteOffset,t);let n="",r=0;for(let o=t-t%4;r<o;r+=4)n+=e.getUint32(r).toString(16).padStart(8,"0");for(;r<t;r++)n+=e.getUint8(r).toString(16).padStart(2,"0");return n},write:function(e,t,n=0,r=c(t)){const o=Math.min(r,e.byteLength-n);for(let r=0;r<o;r++){const o=l(t.charCodeAt(2*r)),i=l(t.charCodeAt(2*r+1));if(void 0===o||void 0===i)return e.subarray(0,r);e[n+r]=o<<4|i}return o}};function l(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-65+10:e>=97&&e<=102?e-97+10:void 0}function f(e){let t=0;for(let n=0,r=e.length;n<r;n++){const o=e.charCodeAt(n);if(o>=55296&&o<=56319&&n+1<r){const r=e.charCodeAt(n+1);if(r>=56320&&r<=57343){t+=4,n++;continue}}t+=o<=127?1:o<=2047?2:3}return t}let h,d;if("undefined"!=typeof TextDecoder){const e=new TextDecoder;h=function(t){return e.decode(t)}}else h=function(e){const t=e.byteLength;let n="",r=0;for(;r<t;){let o=e[r];if(o<=127){n+=String.fromCharCode(o),r++;continue}let i=0,a=0;if(o<=223?(i=1,a=31&o):o<=239?(i=2,a=15&o):o<=244&&(i=3,a=7&o),t-r-i>0){let t=0;for(;t<i;)o=e[r+t+1],a=a<<6|63&o,t+=1}else a=65533,i=t-r;n+=String.fromCodePoint(a),r+=i+1}return n};if("undefined"!=typeof TextEncoder){const e=new TextEncoder;d=function(t,n,r=0,o=f(n)){const i=Math.min(o,t.byteLength-r);return e.encodeInto(n,t.subarray(r,r+i)),i}}else d=function(e,t,n=0,r=f(t)){const o=Math.min(r,e.byteLength-n);e=e.subarray(n,n+o);let i=0,a=0;for(;i<t.length;){const n=t.codePointAt(i);if(n<=127){e[a++]=n,i++;continue}let r=0,o=0;for(n<=2047?(r=6,o=192):n<=65535?(r=12,o=224):n<=2097151&&(r=18,o=240),e[a++]=o|n>>r,r-=6;r>=0;)e[a++]=128|n>>r&63,r-=6;i+=n>=65536?2:1}return o};var g={byteLength:f,toString:h,write:d};function b(e){return 2*e.length}var y={byteLength:b,toString:function(e){const t=e.byteLength;let n="";for(let r=0;r<t-1;r+=2)n+=String.fromCharCode(e[r]+256*e[r+1]);return n},write:function(e,t,n=0,r=b(t)){const o=Math.min(r,e.byteLength-n);let i=o;for(let r=0;r<t.length&&!((i-=2)<0);++r){const o=t.charCodeAt(r),i=o>>8,a=o%256;e[n+2*r]=a,e[n+2*r+1]=i}return o}};!function(e,t){const n=r,o=s,i=u,a=g,c=y,l=255===new Uint8Array(Uint16Array.of(255).buffer)[0];function f(e){switch(e){case"ascii":return n;case"base64":return o;case"hex":return i;case"utf8":case"utf-8":case void 0:return a;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return c;default:throw new Error(`Unknown encoding: ${e}`)}}function h(e){return e instanceof Uint8Array}function d(e,t,n){return"string"==typeof e?function(e,t){const n=f(t),r=new Uint8Array(n.byteLength(e));return n.write(r,e,0,r.byteLength),r}(e,t):Array.isArray(e)?function(e){const t=new Uint8Array(e.length);return t.set(e),t}(e):ArrayBuffer.isView(e)?function(e){const t=new Uint8Array(e.byteLength);return t.set(e),t}(e):function(e,t,n){return new Uint8Array(e,t,n)}(e,t,n)}function b(e,t,n,r,o){if(0===e.byteLength)return-1;if("string"==typeof n?(r=n,n=0):void 0===n?n=o?0:e.length-1:n<0&&(n+=e.byteLength),n>=e.byteLength){if(o)return-1;n=e.byteLength-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof t)t=d(t,r);else if("number"==typeof t)return t&=255,o?e.indexOf(t,n):e.lastIndexOf(t,n);if(0===t.byteLength)return-1;if(o){let r=-1;for(let o=n;o<e.byteLength;o++)if(e[o]===t[-1===r?0:o-r]){if(-1===r&&(r=o),o-r+1===t.byteLength)return r}else-1!==r&&(o-=o-r),r=-1}else{n+t.byteLength>e.byteLength&&(n=e.byteLength-t.byteLength);for(let r=n;r>=0;r--){let n=!0;for(let o=0;o<t.byteLength;o++)if(e[r+o]!==t[o]){n=!1;break}if(n)return r}}return-1}function w(e,t,n,r){return b(e,t,n,r,!0)}function p(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}e.exports=t={isBuffer:h,isEncoding:function(e){try{return f(e),!0}catch{return!1}},alloc:function(e,n,r){const o=new Uint8Array(e);return void 0!==n&&t.fill(o,n,0,o.byteLength,r),o},allocUnsafe:function(e){return new Uint8Array(e)},allocUnsafeSlow:function(e){return new Uint8Array(e)},byteLength:function(e,t){return f(t).byteLength(e)},compare:function(e,t){if(e===t)return 0;const n=Math.min(e.byteLength,t.byteLength);e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let o=n-n%4;r<o;r+=4){if(e.getUint32(r,l)!==t.getUint32(r,l))break}for(;r<n;r++){const n=e.getUint8(r),o=t.getUint8(r);if(n<o)return-1;if(n>o)return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0},concat:function(e,t){void 0===t&&(t=e.reduce(((e,t)=>e+t.byteLength),0));const n=new Uint8Array(t);let r=0;for(const t of e){if(r+t.byteLength>n.byteLength){const e=t.subarray(0,n.byteLength-r);return n.set(e,r),n}n.set(t,r),r+=t.byteLength}return n},copy:function(e,t,n=0,r=0,o=e.byteLength){if(o>0&&o<r)return 0;if(o===r)return 0;if(0===e.byteLength||0===t.byteLength)return 0;if(n<0)throw new RangeError("targetStart is out of range");if(r<0||r>=e.byteLength)throw new RangeError("sourceStart is out of range");if(o<0)throw new RangeError("sourceEnd is out of range");n>=t.byteLength&&(n=t.byteLength),o>e.byteLength&&(o=e.byteLength),t.byteLength-n<o-r&&(o=t.length-n+r);const i=o-r;return e===t?t.copyWithin(n,r,o):t.set(e.subarray(r,o),n),i},equals:function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const n=e.byteLength;e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let r=0;for(let o=n-n%4;r<o;r+=4)if(e.getUint32(r,l)!==t.getUint32(r,l))return!1;for(;r<n;r++)if(e.getUint8(r)!==t.getUint8(r))return!1;return!0},fill:function(e,t,n,r,o){if("string"==typeof t?"string"==typeof n?(o=n,n=0,r=e.byteLength):"string"==typeof r&&(o=r,r=e.byteLength):"number"==typeof t?t&=255:"boolean"==typeof t&&(t=+t),n<0||e.byteLength<n||e.byteLength<r)throw new RangeError("Out of range index");if(void 0===n&&(n=0),void 0===r&&(r=e.byteLength),r<=n)return e;if(t||(t=0),"number"==typeof t)for(let o=n;o<r;++o)e[o]=t;else{const i=(t=h(t)?t:d(t,o)).byteLength;for(let o=0;o<r-n;++o)e[o+n]=t[o%i]}return e},from:d,includes:function(e,t,n,r){return-1!==w(e,t,n,r)},indexOf:w,lastIndexOf:function(e,t,n,r){return b(e,t,n,r,!1)},swap16:function(e){const t=e.byteLength;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let n=0;n<t;n+=2)p(e,n,n+1);return e},swap32:function(e){const t=e.byteLength;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let n=0;n<t;n+=4)p(e,n,n+3),p(e,n+1,n+2);return e},swap64:function(e){const t=e.byteLength;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let n=0;n<t;n+=8)p(e,n,n+7),p(e,n+1,n+6),p(e,n+2,n+5),p(e,n+3,n+4);return e},toBuffer:function(e){return e},toString:function(e,t,n=0,r=e.byteLength){const o=e.byteLength;return n>=o||r<=n?"":(n<0&&(n=0),r>o&&(r=o),(0!==n||r<o)&&(e=e.subarray(n,r)),f(t).toString(e))},write:function(e,t,n,r,o){return void 0===n?o="utf8":void 0===r&&"string"==typeof n?(o=n,n=void 0):void 0===o&&"string"==typeof r&&(o=r,r=void 0),f(o).write(e,t,n,r)},writeDoubleLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat64(n,t,!0),n+8},writeFloatLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat32(n,t,!0),n+4},writeUInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setUint32(n,t,!0),n+4},writeInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setInt32(n,t,!0),n+4},readDoubleLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat64(t,!0)},readFloatLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat32(t,!0)},readUInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(t,!0)},readInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getInt32(t,!0)}}}(t,t.exports);var w=e(t.exports);const p=(e,t)=>t.some((t=>e instanceof t));let m,k;const L=new WeakMap,v=new WeakMap,x=new WeakMap;let I={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return L.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return B(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function S(e){I=e(I)}function E(e){return(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(A(this),t),B(this.request)}:function(...t){return B(e.apply(A(this),t))}}function D(e){return"function"==typeof e?E(e):(e instanceof IDBTransaction&&function(e){if(L.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),r()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)}));L.set(e,t)}(e),p(e,m||(m=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,I):e)}function B(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(B(e.result)),r()},i=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",i)}));return x.set(t,e),t}(e);if(v.has(e))return v.get(e);const t=D(e);return t!==e&&(v.set(e,t),x.set(t,e)),t}const A=e=>x.get(e);function O(e,t,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){const a=indexedDB.open(e,t),s=B(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(B(a.result),e.oldVersion,e.newVersion,B(a.transaction),e)})),n&&a.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),s.then((e=>{i&&e.addEventListener("close",(()=>i())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}const C=["get","getKey","getAll","getAllKeys","count"],M=["put","add","delete","clear"],U=new Map;function N(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(U.get(t))return U.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=M.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!C.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let a=i.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),o&&i.done]))[0]};return U.set(t,i),i}S((e=>({...e,get:(t,n,r)=>N(t,n)||e.get(t,n,r),has:(t,n)=>!!N(t,n)||e.has(t,n)})));const q=["continue","continuePrimaryKey","advance"],z={},P=new WeakMap,V=new WeakMap,j={get(e,t){if(!q.includes(t))return e[t];let n=z[t];return n||(n=z[t]=function(...e){P.set(this,V.get(this)[t](...e))}),n}};async function*T(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,j);for(V.set(n,t),x.set(n,A(t));t;)yield n,t=await(P.get(n)||t.continue()),P.delete(n)}function _(e,t){return t===Symbol.asyncIterator&&p(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&p(e,[IDBIndex,IDBObjectStore])}S((e=>({...e,get:(t,n,r)=>_(t,n)?T:e.get(t,n,r),has:(t,n)=>_(t,n)||e.has(t,n)})));const H=F(!1),R=F(!0);function F(e){const t={};t.posix=t,t.win32=t;const n=t.sep=e?"\\":"/";return e?(t.isAbsolute=function(e){return 0!==e.length&&("\\"===e[0]||"/"===e[0]||2===e.length&&":"===e[1]||e.length>2&&":"===e[1]&&("\\"===e[2]||"/"===e[2]))},t.root=function(e){return 0===e.length?"":"\\"===e[0]||"/"===e[0]?e[0]:2===e.length&&":"===e[1]?e:e.length>2&&":"===e[1]&&("\\"===e[2]||"/"===e[2])?e.slice(0,3):""}):(t.isAbsolute=function(e){return e.length>0&&"/"===e[0]},t.root=function(e){return t.isAbsolute(e)?"/":""}),t.basename=function(e){let t=e.length-1;for(;t>0&&e[t]===n;)t--;return t<=0?"":e.slice(e.lastIndexOf(n,t)+1,t+1)},t.dirname=function(e){let t=e.length-1;for(;t>0&&e[t]===n;)t--;if(t<=0)return"";const r=e.lastIndexOf(n,t);return-1===r?"":e.slice(0,r)},t.extname=function(e){const t=e.lastIndexOf(".");return-1===t?"":e.slice(t)},t.resolve=function(e,n){return void 0===n?t.normalize(e):t.isAbsolute(n)?t.normalize(n):t.join(e,n)},t.join=function(e,...r){for(const t of r)e+=n+t;return t.normalize(e)},t.normalize=function(r){if(!0===e){let e=-1;for(;-1!==(e=r.indexOf("/",e+1));)r=r.slice(0,e)+n+r.slice(e+1)}const o=t.root(r),i=""!==o;let a=o.length,s="";for(;a<r.length;){let e=r.indexOf(n,a);-1===e&&(e=r.length);const t=r.slice(a,e);if(a=e+1,""!==t&&"."!==t)if(".."!==t)s+=s?n+t:t;else{const e=s.lastIndexOf(n);-1===e||".."===s.slice(e+1)?i?s="":s+=s?n+"..":"..":s=s.slice(0,e)}}return o&&(s=o+s),s||"."},t}H.win32=R,R.posix=H;var K=e("win32"===process.platform?R:H),W={exports:{}},Q=function(e){var t=new e,n=t;return{get:function(){var r=t;return r.next?t=r.next:(t=new e,n=t),r.next=null,r},release:function(e){n.next=e,n=e}}};function Y(e,t,n){if("function"==typeof e&&(n=t,t=e,e=null),!(n>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");var r=Q(G),o=null,i=null,a=0,s=null,c={push:function(l,f){var h=r.get();h.context=e,h.release=u,h.value=l,h.callback=f||$,h.errorHandler=s,a>=n||c.paused?i?(i.next=h,i=h):(o=h,i=h,c.saturated()):(a++,t.call(e,h.value,h.worked))},drain:$,saturated:$,pause:function(){c.paused=!0},paused:!1,get concurrency(){return n},set concurrency(e){if(!(e>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");if(n=e,!c.paused)for(;o&&a<n;)a++,u()},running:function(){return a},resume:function(){if(c.paused)for(c.paused=!1;o&&a<n;)a++,u()},idle:function(){return 0===a&&0===c.length()},length:function(){for(var e=o,t=0;e;)e=e.next,t++;return t},getQueue:function(){for(var e=o,t=[];e;)t.push(e.value),e=e.next;return t},unshift:function(l,f){var h=r.get();h.context=e,h.release=u,h.value=l,h.callback=f||$,h.errorHandler=s,a>=n||c.paused?o?(h.next=o,o=h):(o=h,i=h,c.saturated()):(a++,t.call(e,h.value,h.worked))},empty:$,kill:function(){o=null,i=null,c.drain=$},killAndDrain:function(){o=null,i=null,c.drain(),c.drain=$},error:function(e){s=e}};return c;function u(s){s&&r.release(s);var u=o;u&&a<=n?c.paused?a--:(i===o&&(i=null),o=u.next,u.next=null,t.call(e,u.value,u.worked),null===i&&c.empty()):0==--a&&c.drain()}}function $(){}function G(){this.value=null,this.callback=$,this.next=null,this.release=$,this.context=null,this.errorHandler=null;var e=this;this.worked=function(t,n){var r=e.callback,o=e.errorHandler,i=e.value;e.value=null,e.callback=$,e.errorHandler&&o(t,i),r.call(e.context,t,n),e.release(e)}}W.exports=Y;var J=W.exports.promise=function(e,t,n){"function"==typeof e&&(n=t,t=e,e=null);var r=Y(e,(function(e,n){t.call(this,e).then((function(e){n(null,e)}),n)}),n),o=r.push,i=r.unshift;return r.push=function(e){var t=new Promise((function(t,n){o(e,(function(e,r){e?n(e):t(r)}))}));return t.catch($),t},r.unshift=function(e){var t=new Promise((function(t,n){i(e,(function(e,r){e?n(e):t(r)}))}));return t.catch($),t},r.drained=function(){if(r.idle())return new Promise((function(e){e()}));var e=r.drain;return new Promise((function(t){r.drain=function(){e(),t()}}))},r},X={exports:{}};function Z(){}Z.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var r=this;function o(){r.off(e,o),t.apply(n,arguments)}return o._=t,this.on(e,o,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,o=n.length;r<o;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],o=[];if(r&&t)for(var i=0,a=r.length;i<a;i++)r[i].fn!==t&&r[i].fn._!==t&&o.push(r[i]);return o.length?n[e]=o:delete n[e],this}},X.exports=Z,X.exports.TinyEmitter=Z;var ee=e(X.exports);const te=await O("###meta",void 0,{upgrade(e){const t=e.createObjectStore("meta",{keyPath:"fileName",autoIncrement:!1});t.createIndex("length","length"),t.createIndex("type","type"),t.createIndex("chunkSize","chunkSize")}});async function ne(e,t={},n=!0,r=!0){const o=e.transaction("chunks","readonly"),i=o.objectStore("chunks");let a;a=null==t.end?IDBKeyRange.lowerBound(t.start,!r):null==t.start?IDBKeyRange.upperBound(t.end,!n):t.start&&t.end?IDBKeyRange.bound(t.start,t.end,!n,!r):void 0;const s=await i.getAll(a);return await o.done,s}async function re(e,t=[]){Array.isArray(t)||(t=[t]);const n=e.transaction("chunks","readwrite"),r=n.objectStore("chunks"),o=[];for(const{chunk:e,data:n}of t)o.push(r.put({chunk:e,data:n}));o.push(n.done),await Promise.all(o)}let oe={chunkSize:4096,MapClass:Map};function ie(e){return Promise.resolve(e(oe)).then((e=>{oe=e}))}let ae=null;function se(e,t={}){const{size:n,chunkSize:r=n,MapClass:o,openBlockingHandler:i=((t,n,r)=>(console.warn("Closed due to blocking.",e),ae.get(e)?.close(),r.target.close())),openBlockedHandler:a,deleteBlockingHandler:s,prefix:c,directory:u=c}={...oe,...t};if(u&&(e=K.join(u,K.resolve("/",e).replace(/^\w+:\\/,""))),ae||(ae=new o),ae.has(e)){const t=ae.get(e);if(!t.closed)return t;ae.delete(e)}t.chunkSize||=r;const l=new ce({ready:()=>async function(e,t={}){const{openBlockingHandler:n,openBlockedHandler:r}=t;if("######meta"===e)throw new Error("Reserved db name");return await O(e,void 0,{upgrade(e){e.createObjectStore("chunks",{keyPath:"chunk",autoIncrement:!1}).createIndex("data","data")},blocking(e,t,r){n(e,t,r)},blocked(...e){r(...e)}})}(e,{openBlockingHandler:i,openBlockedHandler:a,...t}),fileName:e,...t});return l.deleteBlockingHandler=s,ae.set(e,l),l}class ce extends ee{constructor({ready:e,fileName:t,chunkSize:n}){super(),this.ready=e,this.suspended=!1,this.opened=!1,this.closed=!0,this.meta={fileName:t,chunkSize:n,length:0},this._startQ()}get fileName(){return this.meta.fileName}get length(){return this.meta.length||0}get chunkSize(){return this.meta.chunkSize}async getMeta(){const e=await function(e){const t=te.transaction("meta","readonly");return t.objectStore("meta").get(e).then((async e=>(await t.done,e))).catch((e=>(console.log("Failed to get meta",e),!1)))}(this.fileName)||{};this.meta={...this.meta,...e}}async saveMeta(){return async function(e){const t=te.transaction("meta","readwrite"),n=t.objectStore("meta");return await n.put(e),t.done}(this.meta)}async setLength(e){return this.meta.length=e,this.saveMeta()}_startQ(){const e=this;if(this.queue)return;let t;this.queue||=J((async({task:n,request:r})=>{try{e.opened||await e.__open,t=setTimeout((()=>{console.error("The queue stalled",{task:n,request:r})}),1e4);const o=await Promise.resolve(n());return r.callback&&await r.callback(null,o),o}catch(e){if(r.callback)return r.callback(e);throw e}finally{t&&clearTimeout(t)}}),1)}async purge(e){const t=this;await new Promise((e=>t.close(e))),await function(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",(e=>t(e.oldVersion,e))),B(n).then((()=>{}))}(t.fileName,{blocked(...e){t.deleteBlockingHandler&&t.deleteBlockingHandler(...e)}}),await function(e){const t=te.transaction("meta","readwrite");return t.objectStore("meta").delete(e).then((async e=>(await t.done,e))).catch((e=>(console.log("Failed to del meta",e),!1)))}(t.fileName),await this.close(),e?.()}_blocks(e,t){return function(e,t,n){const r=[];for(let o=Math.floor(t/e)*e;o<n;o+=e)r.push({block:Math.floor(o/e),start:Math.max(o,t)%e,end:Math.min(o+e,n)%e||e});return r}(this.chunkSize,e,t)}async __open(){const e=this;(!this.opened||this.closed||this.suspended)&&(e.db=await e.ready(),await e.getMeta(),e.suspended&&(e.emit("unsuspend"),e.suspended=!1,e.queue.resume()),e.opened||e.emit("open",this),e.closed=!1,e.opened=!0)}open(e=ue){this.__open().then(e)}read(e,t,n=ue){const r=this;this.open((()=>{r.queue.push({request:{callback:n},async task(){if(0===t)return w.alloc(0);const{db:n,length:o}=r;if(0===o){const e=new Error("No file");throw e.code="ENOENT",e}if(t===Number.POSITIVE_INFINITY&&(t=o-e),(o||0)<e+t)throw new Error("Could not satisfy length ");const i=r._blocks(e,e+t);if(!i.length)throw new Error("Could not find blocks of specified: "+this.fileName);const[{block:a}]=i,{block:s}=i[i.length-1],c=await ne(n,{start:a,end:s},!0,!0);if(!c.length)return w.alloc(0);let u=0;const l=[];for(const{data:e,chunk:t}of Object.values(c)){if(u=t-a,!i[u])continue;const{start:n,end:r}=i[u];l[u]=w.from(e.slice(n,r))}return w.from(w.concat(l))}})}))}write(e,t,n=ue){const r=this;this.open((()=>{r.queue.push({request:{callback:n},async task(){const{chunkSize:n,length:o,db:i}=r,a=r._blocks(e,e+t.length);if(!a.length)throw new Error("Could not get chunks ("+e+" - "+t.length+")");const[{block:s}]=a,{block:c}=a[a.length-1];let u;const l=await ne(i,{start:s,end:c},!0,!0);for(let[e,t]of Object.entries(l))l[e]=t?.data;let f=0,h=0;const d=i.transaction("chunks","readwrite"),g=d.objectStore("chunks");for(const{block:e,start:r,end:o}of a){const i=h++,a=o-r;a===n?l[i]=w.from(t.slice(f,f+a)):(l[i]||=w.from(w.alloc(n)),w.copy(w.from(t),l[i],r,f,f+a)),await g.put({chunk:e,data:w.from(l[i])}),f+=a}return u=Math.max(o||0,e+t.length),await d.done,await r.setLength(u),null}})}))}del(e,t,n=ue){const r=this;this.open((()=>{const{length:o}=r;if(t===Number.POSITIVE_INFINITY&&(t=o-e),e+t>o&&(t=Math.max(0,o-e)),e+t>=o)return r.truncate(e,n);r.queue.push({request:{callback:n},async task(){const{db:n,chunkSize:o}=r,i=r._blocks(e,e+t);if(!i.length)throw new Error("No blocks found to delete."+this.fileName);const a=i.shift(),s=i.pop()||a;if(!a)throw new Error("No blocks found to delete."+this.fileName);s.block-a.block>1&&await ne(n,{start:a.block,end:s.block},!1,!1);const{0:c,1:u}=await ne(n,{start:a.block,end:s.block},!0,!0);if(c){const e=u?a.end:a.end-a.start,t=w.alloc(e);w.copy(t,c.data,a.start),await re(n,c)}if(u){const e=Math.min(s.end,o),t=w.alloc(e);w.copy(t,u.data,s.start),await re(n,u)}}})}))}suspend(e){const t=this;this.queue.pause(),this.suspended=!0,setTimeout((()=>{t.emit("suspend"),e()}))}truncate(e,t=ue){const n=this;this.open((()=>{const{length:r}=n;return e===r?t(null,null):e>r?n.write(r,w.alloc(e-r),(e=>t(e||null,null))):void n.queue.push({request:{callback:t},async task(){const{length:t,chunkSize:r,db:o}=n;if(e===t)return null;const i=n._blocks(e,t),[{block:a,start:s,end:c}]=i,[u,...l]=await ne(o,{start:a},!0),f=o.transaction("chunks","readwrite"),h=f.objectStore("chunks");if(l.length>0){const e=[];for(const t of l)e.push(h.delete(t.chunk));await Promise.all(e)}const d=c-s;if(d===r)await h.delete(a);else{let{data:e,chunk:t}=u,n=w.alloc(d);w.copy(n,e,s,s,d),await h.put({chunk:t,data:e})}return await f.done,await n.setLength(e),null}})}))}stat(e=ue){const t=this;this.open((n=>{if(n)return e(n);this.queue.push({request:{callback:e},task:()=>({fileName:t.fileName,length:t.length,size:t.length,chunkSize:t.chunkSize,blksize:t.chunkSize})})}))}close(e=ue){const t=this;this.open((()=>{t.queue.push({async task(){if(t.closed)return e(null);t.emit("close"),t.closed=!0,t.opened=!1,t.db.close(),ae.delete(t.fileName)},request:{callback:e}})}))}}function ue(){return()=>null}export{ae as allLoadedFiles,se as createFile,se as default,oe as defaultConfig,ie as updateDefaultConfig};
